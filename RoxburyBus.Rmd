---
title: "Roxbury Bus Data vs Air Quality"
date: "2023-11-07"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

This file generates plots of bus arrival times and the corresponding pollution readings.

Simply press `Ctrl + Alt + R` to run all and get the figures. Go to `./helpers/`
and run the file `exporting_html.R` according to instructions in the file to get
the html export of this file. Note that this file is quite memory taxing so make
sure that your R memory (the pie chart at the top of the Environment tab) is
green to make sure nothing crashes. 

## INITIAL SETTINGS

```{r}
packages <- c("openair", "openairmaps", "leaflet", "dplyr", "plotly", "shiny")
install.packages(packages[!sapply(packages, requireNamespace, quietly = TRUE)])

# Load required packages for data manipulation and analysis
invisible(sapply(packages, library, character.only = TRUE))

# Load necessary libraries
library(readr)
library("leaflet")

roxbury_busdata <- read_csv("roxbury_busdata.csv")
View(roxbury_busdata)

# Set options
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

# Loading Data

```{r}
# Combine two columns
roxbury_busdata$latAndlong <- paste(roxbury_busdata$lat, roxbury_busdata$long, sep = "_")

# Find unique values within the combined column
unique_values <- unique(roxbury_busdata$latAndlong)

# Split unique values back into latitude and longitude
unique_lat_long <- strsplit(unique_values, "_")
unique_latitudes <- as.numeric(sapply(unique_lat_long, function(x) as.numeric(x[1])))
unique_longitudes <- as.numeric(sapply(unique_lat_long, function(x) as.numeric(x[2])))

# Create a leaflet map
m <- leaflet() %>%
  setView(lng = mean(unique_longitudes), lat = mean(unique_latitudes), zoom = 10) %>%
  addTiles()  # Add default OpenStreetMap tiles

# Add markers for each unique location
for (i in 1:length(unique_latitudes)) {
  m <- addMarkers(m, lng = unique_longitudes[i], lat = unique_latitudes[i], popup = paste("Location ", i))
}

```

Display the map of bus stops within the data set

```{r}
m
```

```{r}
# Load data frame of data from AirPartners
load("../data/graphableData.RData")

# Filter the data to include only the desired time range (time range change)
start_date <- as.Date("2023-01-01")
end_date <- as.Date("2023-02-28")
mod_met_filtered <- mod_met[mod_met$date >= start_date & mod_met$date <= end_date, ]

# Make a smaller dataset so things run faster
mod_met_filtered <- mod_met_filtered[, c("date", "sn", "pm1", "pm25", "pm10", "ws", "wd", "lat", "lon")]
```



```{r}
polarMapData <- polarMap(
  mod_met_filtered,
  pollutant = c("pm1"),
  latitude = "lat",
  longitude = "lon",
  limits = c(0, 5),
  key = TRUE,
  provider = "OpenStreetMap")

polarMapData
```

```{r}
# List of sensor IDs
sensor_ids <- unique(mod_met_filtered$sn)
print(sensor_ids)

sensor_00212 <- mod_met_filtered %>% filter(sn == "MOD-PM-00212")
sensor_00213 <- mod_met_filtered %>% filter(sn == "MOD-PM-00213")
sensor_00214 <- mod_met_filtered %>% filter(sn == "MOD-PM-00214")
sensor_00216 <- mod_met_filtered %>% filter(sn == "MOD-PM-00216")
sensor_00217 <- mod_met_filtered %>% filter(sn == "MOD-PM-00217")
sensor_00222 <- mod_met_filtered %>% filter(sn == "MOD-PM-00222")
sensor_00224 <- mod_met_filtered %>% filter(sn == "MOD-PM-00224")
sensor_00226 <- mod_met_filtered %>% filter(sn == "MOD-PM-00226")
sensor_00230 <- mod_met_filtered %>% filter(sn == "MOD-PM-00230")
sensor_00231 <- mod_met_filtered %>% filter(sn == "MOD-PM-00231")
```
```{r}
write.csv(sensor_00212, file = "sensor_00212_data.csv", row.names = FALSE)
```


